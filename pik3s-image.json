{
    "variables": {
        "ssh_key_src": "https://github.com/samlinville.keys",
        "image_home_dir": "/home/sam",
        "system_user": "sam",
        "system_password": "",
        "tailscale_key": ""
    },
    "builders": [{
      "type": "arm-image",
      "image_type": "raspberrypi",
      "qemu_binary": "qemu-aarch64-static",
      "iso_url" : "http://cdimage.ubuntu.com/releases/20.04.1/release/ubuntu-20.04.1-preinstalled-server-arm64+raspi.img.xz",
      "iso_checksum":"sha256:aadc64a1d069c842e56a4289fe1a6b4b5a0af4efcf95bcce78eb2a80fe5270f4",
      "last_partition_extra_size" : "1073741824",
      "image_mounts": ["/boot/firmware","/"],
      "chroot_mounts": [
          ["proc", "proc", "/proc"],
          ["sysfs", "sysfs", "/sys"],
          ["bind", "/dev", "/dev"],
          ["devpts", "devpts", "/dev/pts"],
          ["binfmt_misc", "binfmt_misc", "/proc/sys/fs/binfmt_misc"],
          ["bind", "/run/resolvconf", "/run/resolvconf"]
      ]
    }],  
    "provisioners": [
      {
        "type": "shell",
        "inline": [
            "sleep 30",
            "touch /boot/ssh",
            "sudo useradd -d {{user `image_home_dir`}} -p $(openssl passwd -1 {{user `system_password`}}) {{user `system_user`}}",
            "usermod -aG sudo {{user `system_user`}}"
        ]
      },

      {
          "type": "shell",
          "inline": [
              "curl {{user `ssh_key_src`}} >> ~/.ssh/authorized_keys",
              "curl {{user `ssh_key_src`}} >> {{user `image_home_dir`}}/.ssh/authorized_keys"
          ]
      },
      {
        "type": "shell",
        "inline": [
          "sed '/PasswordAuthentication/d' -i /etc/ssh/sshd_config",
          "echo  >> /etc/ssh/sshd_config",
          "echo 'PasswordAuthentication no' >> /etc/ssh/sshd_config"
        ]
      },
      {
        "type": "shell",
        "inline": [
            "curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/focal.gpg | sudo apt-key add -",
            "curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/focal.list | sudo tee /etc/apt/sources.list.d/tailscale.list",
            "sudo apt-get update",
            "sudo apt-get install tailscale -y",
            "sudo tailscale up --authkey {{user `tailscale_key`}}"
        ]
      }
    ]
  }